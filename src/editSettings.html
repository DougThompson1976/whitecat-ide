<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="icon.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="lib/bootstrap/css/bootstrap-theme.min.css">
  
  <script src="lib/jquery-1.12.3.min.js"></script>
  
  <script src="lib/bootstrap/js/bootstrap.min.js"></script>
  <script src="lib/bootstrap/js/bootstrap-dialog.js"></script>
  <script src="lib/bootstrap/js/bootbox.min.js"></script>
  
  <script src="code.js"></script>
  <script src="adapters/adapter.js"></script>
  <script src="aceeditor/ace.js"></script>
  <script src="aceeditor/ext-language_tools.js"></script>
</head>
<body>
  <table width="100%" height="100%">
    <tr>
      <td colspan=2>
		  <div class="btn-toolbar" role="toolbar" style="background-image: linear-gradient(to bottom,#fff 0,#e0e0e0 100%);"> 
		  	<div class="btn-group">
  			  <button id="saveButton" type="button" class="btn btn-default" aria-label="Left Align">
  			    <span class="icon icon-floppy-disk" aria-hidden="true"></span>
  			  </button>
  			  <button id="saveAsButton" type="button" class="btn btn-default" aria-label="Left Align">
  			    <span class="icon icon-floppy-disks" aria-hidden="true"></span>
  			  </button>
			</div>
		</td>
	</tr>
    <tr>
      <td height="99%" colspan=2 id="content_area">
      </td>
    </tr>
  </table>
  <div id="content_editor"></div>
</body>
</html>
<script>

// Editor instance
var editor;

// json file to edit
var file;

// File path of json file to edit
var filePath;

// Tipe of setting
var type;

function save() {	
    var fs = require('fs');
    var path = require('path');
	var data = "";

	try {
		// Get content file from editor
		data = editor.getValue();
		
		// Check
		if (type == "adapter") {
			if (Adapters.check(file, JSON.parse(data))) {
				// Content is valid, write it
			    fs.writeFileSync(path.join(filePath, file), data);
				
				// Reload app
				chrome.runtime.reload();			
			}			
		} else {
			// Reload app
			chrome.runtime.reload();			
		}
	} catch (error) {
		Code.showError(MSG['error'], MSG['youHaveAnErrorInFile'] + file + ':<br><br>' + error);	
		
		return;
	}	
}

function saveAs() {	
	bootbox.prompt("Enter file name (without extension)", function(result) {
		if (result !== null) {
			file = result + ".json";
			save();
		}
	});
}

function onResize(e) {
    var container = document.getElementById('content_area');
    var bBox = Code.getBBox_(container);
	el = document.getElementById('content_editor');	
    el.style.top = bBox.y + 'px';
    el.style.left = bBox.x + 'px';
    el.style.height = (bBox.height) + 'px';
    el.style.width = bBox.width + 'px';	
}

window.addEventListener('resize', onResize, false);

window.addEventListener('load', function() {
	// Get arguments
	file = window.opener.Adapters.editArgs.file;
	filePath = window.opener.Adapters.editArgs.path;
	type = window.opener.Adapters.editArgs.type;

	// Read file
    var fs = require('fs');
    var path = require('path');
	var jsonFile = fs.readFileSync(path.join(filePath, file), "utf8");
	
	// Create editor
    ace.require("ace/ext/language_tools");
    editor = ace.edit(document.getElementById("content_editor"));
    editor.setShowPrintMargin(true);
    editor.setPrintMarginColumn(120);
    editor.setOptions({ enableBasicAutocompletion: true });
    editor.$blockScrolling = Infinity;	
	
	// Load json file into editor
	editor.setValue(jsonFile, -1);	
	
  	Code.bindClick('saveButton', save);
  	Code.bindClick('saveAsButton', saveAs);
	
	// Resize
	onResize();	
});
</script>